---
title: "LURN SI-29 data dashboard"
params:
    patient_id: 1
    patient_week: NULL
    study_arm: NULL
    reference_population : "study_arm"
    show_density: FALSE
    show_median: TRUE
    show_table: FALSE
    annotate_plot: FALSE
    autoscale_symptoms_axis: FALSE
output: 
    flexdashboard::flex_dashboard:
        orientation: rows
        vertical_layout: fill
        horizontal_layout: fill
---

```{css}
.chart-wrapper{
    border: 2px solid black;
}
.value-box{
    border: 2px solid black;
}
.value-box .inner{
    padding: 0px 0px 0px 10px;
}
.value-box .value {
    font-size: 20px;
    margin: 0px;
}
.chart-title {
    font-size: 24px;
}

/* for the columns with combined plots and value boxes */
.plot-box-combined.value-box {
    height: 54px;
    text-align: left;
    border-top: none;
    border-radius: none;
}
.plot-box-combined.chart-wrapper{
    margin-bottom: 0px;
    border-bottom: none;
    border-radius: 0px;
}

/* the table needs scroll bars */
.scrollable-table .chart-shim{
    overflow-y: auto;
}

```


```{r global}
library(lurn)
library(ggplot2)
library(flexdashboard)
library(gt)
library(dplyr)
library(tidyr)
library(cowplot)
library(magick)
library(ggnewscale)
library(stringr)
library(lubridate)
library(webshot)

# data file
datafile <- "../data/EH22021EnhancedClini-LURNSI29Report_DATA_2023-12-01_1444.csv"

# AMG codes
source("data_cleaning.R")
source("plotting_functions.R")
source("table_functions.R")

# for renaming columns
splom_vars <- c(
   "lurn_si_29_total_score", 
   "lurn_si_29_incontinence_score",
   "lurn_si_29_pain_score", 
   "lurn_si_29_voiding_score",
   "lurn_si_29_urgency_score", 
   "lurn_si_29_nocturia_score",
   "lurn_si_29_bother")
symptoms <- c("Total", 
    "Incontinence", 
    "Pain", 
    "Voiding", 
    "Urgency", 
    "Nocturia", 
    "Bother"
)
splom_vars <- rev(splom_vars)
symptoms <- rev(symptoms)

bph <- clean_real_data(
    read.csv(datafile), 
    params$patient_id,
    params$study_arm, 
    params$patient_week,
    splom_vars,
    symptoms
)

# save the input parameters (so that I can defaults from data_cleaning)
input_params <- list(
    patient_id = params$patient_id, 
    patient_week = bph$patient_week, 
    study_arm = bph$study_arm,
    show_density = params$show_density,
    show_median = params$show_median,
    autoscale_symptoms_axis = params$autoscale_symptoms_axis,
    reference_population = params$reference_population,
    show_median = params$show_median, 
    show_density = params$show_density,
    annotate_plot = params$annotate_plot
)





```



Plots
=====================================   

Row {data-height=1200, id="chart1"}
-------------------------------------

### Symptoms Summary for Patient `r input_params$patient_id` at Week `r input_params$patient_week`
    
```{r, fig.width = 10, fig.height = 14}

bar_chart <- create_current_week_summary_bar_chart(
    bph$dat_arm, 
    symptoms, 
    input_params
)
line_plot <- create_time_series_line_plot(
    bph$dat_arm, 
    symptoms, 
    input_params
)
legend <- create_legend()

g <- plot_grid(
    bar_chart, 
    line_plot, 
    ncol = 2, 
    align = "h", 
    rel_widths = c(0.49,0.51), 
    axis = "l"
)
p <- plot_grid(
    g, 
    legend, 
    ncol = 1, 
    rel_heights = c(1, 0.2)
)


# save the image and then read it back in so that I can annotate it more easily and have consistent sizing!
tmp <- tempfile("image0", fileext = ".png")
ggsave(tmp, p, width = 12, height = 9)
img <- image_read(tmp)

if (input_params$annotate_plot) img <- annotate_img(img, "#a200aa")

image_trim(img)

```


<!-- 
Row {data-height=125}
-------------------------------------

### Description
The figures above show results from survey(s) you filled out recording the level of your symptoms at each doctor visit.  

The panels on the left show your current symptoms in color-filled rectangles compared to a reference population shown in gray lines. The panels on the right show your symptoms over time in color-filled circles compared to the same reference population shown in gray dashed lines. 

In all panels, the color indicates how your symptom level compares with that of the reference population, with blue being lower and orange being higher than the reference population, as indicated by the colorbar at the bottom.   
-->



Tables
=====================================  

Row {data-width=1050}
-------------------------------------

### Patient Scores Compared to Aggregate for Patient `r input_params$patient_id` at Week `r input_params$patient_week` {class="scrollable-table"}

```{r}
create_full_table(bph$all_arm, input_params)
```


<!-- used to click on the Tables panel so that I can render it -->
```{r results='asis'}
if (params$show_table) {
  js_code <- '<script>console.log("trying to show table");setTimeout(function() {var tablesPanel = document.querySelector(\'a[href="#tables"]\');tablesPanel.click();}, 100);</script>'
} else {
  js_code <- ''
}
cat(js_code)
```